# test_rtx.py   (расположите в корне проекта)
import json
import numpy as np
from pathlib import Path
import alkash3d_rtx      # ← наш PyO3‑модуль, установленный через maturin
from PIL import Image

def make_dummy_scene(width: int, height: int) -> str:
    """
    Минимальная сцена: без мешей, только камера.
    Соответствует тому, что `RTXRenderer._scene_to_payload`
    передаёт в Rust‑модуль.
    """
    payload = {
        "meshes": [],                     # нет геометрии – будет только фон
        "camera": {
            "position": [0.0, 0.0, 5.0],
            # простая view‑матрица (матрица идентичности)
            "view": [
                [1.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 1.0],
            ],
            # простая перспективная проекция (FOV≈90°)
            "proj": [
                [1.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 1.0],
            ],
        },
    }
    return json.dumps(payload)


if __name__ == "__main__":
    w, h = 800, 600                     # любой размер, который вам удобен
    scene_json = make_dummy_scene(w, h)

    # -----------------------------------------------------------------
    # 1️⃣ Вызов Rust‑трассера
    # -----------------------------------------------------------------
    try:
        rgba_bytes = alkash3d_rtx.render_frame(scene_json, w, h)
    except Exception as exc:
        print("[ERROR] Rust‑модуль не отработал:", exc)
        raise

    # -----------------------------------------------------------------
    # 2️⃣ Превращаем `bytearray` → `numpy` массив (h × w × 4, uint8)
    # -----------------------------------------------------------------
    img = np.frombuffer(rgba_bytes, dtype=np.uint8).reshape((h, w, 4))

    # -----------------------------------------------------------------
    # 3️⃣ Сохраняем в PNG (чтобы увидеть результат без OpenGL)
    # -----------------------------------------------------------------
    out_path = Path(__file__).with_name("rtx_test_output.png")
    Image.fromarray(img, mode="RGBA").save(out_path)
    print(f"[OK] Сохранено изображение → {out_path}")

    # -----------------------------------------------------------------
    # 4️⃣ (Опционально) выведем статистику пикселей
    # -----------------------------------------------------------------
    print("Минимум/максимум каналов:", img.min(axis=(0, 1)), img.max(axis=(0, 1)))
    print("Среднее значение (R,G,B,A):", img.mean(axis=(0, 1)))
